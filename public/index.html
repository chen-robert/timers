<html>
  <head>
    <link rel="stylesheet" href="/styles/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  </head>
  <body>
    <input id="name" autocomplete="off">
    <div class="timers-list" id="timers"></div>
    <script>
      const data = {};
      const state = {};

      const init = name => {
        if(Object.keys(state).includes(name)) return;

        data[name] = [];
        state[name] = {
          time: 0,
          last: -1,
          playing: false
        }

        $("#timers").append(`
        <div class="timer">
          <div class="playbtn-wrapper">
            <button class="playbtn" data-tag="${name}"></button>
          </div>
          <div class="timer__tag">
            <span>${name}</span>
          </div>
          <div class="timer__seperator"></div>
          <div class="time" data-tag="${name}">
          </div>
        </div>
        `);

        $(`.playbtn[data-tag="${name}"]`).click(function() {
          $(this).toggleClass("paused");

          const opt = $(this).hasClass("paused") ? "play": "pause";

          const tag = $(this).data("tag");
          const time = Date.now();
          state[tag].last = time;
          state[tag].playing = opt === "play";

          data[tag].push({
            time,
            opt
          });
        });
      }

      $("#name").on("keypress", e => {
        if(e.which === 13) {
          init($("#name").val());
          $("#name").val("");
        }
      })

      setInterval(() => {
        for(const [tag, data] of Object.entries(state)) {
          if(data.playing) {
            const time = Date.now();
            data.time += time - data.last;
            data.last = time;

            setTime($(`.time[data-tag="${tag}"]`), data.time);
          }
        }
      }, 10);

      const setTime = (elem, ms) => {
        let sec = ms / 1000;
        let min = sec / 60;
        let hrs = min / 60;

        ms = Math.floor((ms / 10) % 100);
        sec = Math.floor(sec % 60);
        min = Math.floor(min % 60);
        hrs = Math.floor(hrs); 

        const template = (num, letter) => `
        <span class="time__number" data-letter="${letter}">${num < 10? "0" + num: num}</span><span class="time__letter">${letter}</span>
        `;

        const missingLetter = letter => $(elem).find(`span[data-letter="${letter}"]`).length === 0;

        let valid = true;
        if(hrs > 0 && missingLetter("h")) valid = false;
        if(min > 0 && missingLetter("m")) valid = false;
        if(sec > 0 && missingLetter("s")) valid = false;
        if(ms > 0 && missingLetter("")) valid = false;
        
        if(valid) {
          const setLetter = (val, letter) => $(elem).find(`span[data-letter="${letter}"]`).text(val < 10? "0" + val: val);

          if(hrs > 0) setLetter(hrs, "h");
          if(min > 0) setLetter(min, "m");
          if(sec > 0) setLetter(sec, "s");
          if(ms > 0) setLetter(ms, "");
        } else {
          let html = "";
          if(hrs > 0) html += template(hrs, "h");
          if(min > 0) html += template(min, "m");
          if(sec > 0) html += template(sec, "s");
          if(ms > 0) html += template(ms, "");
          $(elem).html(html);
        }

      }
    </script>
  </body>
</html>